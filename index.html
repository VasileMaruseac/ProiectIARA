<!DOCTYPE html>
<html>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <!-- we import arjs version without NFT but with marker + location based support -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js" integrity="sha512-tVYBzEItJit9HXaWTPo8vveXlkK62LbA+wez9IgzjTmFNLMBO1BEYladBw2wnM3YURZSMUyhayPCoLtjGh84NQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js" integrity="sha512-u9akINsQsAkG9xjc1cnGF4zw5TFDwkxuc9vUp5dltDWYCSmyd0meygbvgXrlc/z7/o4a19Fb5V0OUE58J7dcyw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.3/firebase.js"></script>
  <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAjso9FrgHIB1iDxtTUSP_49tchXkdrLC8",
          authDomain: "storeimgforrectext.firebaseapp.com",
          databaseURL: "https://storeimgforrectext-default-rtdb.europe-west1.firebasedatabase.app/",
          projectId: "storeimgforrectext",
          storageBucket: "storeimgforrectext.appspot.com",
          messagingSenderId: "1040682706028",
          appId: "1:1040682706028:web:292fd0c9b91e26f114e449",
          measurementId: "G-4CE3YP6P92"
        };
 
          firebase.initializeApp(firebaseConfig);
          
        // (function() {
        //     var cors_api_host = 'cors-anywhere.herokuapp.com';
        //     var cors_api_url = 'https://' + cors_api_host + '/';
        //     var slice = [].slice;
        //     var origin = window.location.protocol + '//' + window.location.host;
        //     var open = XMLHttpRequest.prototype.open;
        //     XMLHttpRequest.prototype.open = function() {
        //         var args = slice.call(arguments);
        //         var targetOrigin = /^https?:\/\/([^\/]+)/i.exec(args[1]);
        //         if (targetOrigin && targetOrigin[0].toLowerCase() !== origin &&
        //             targetOrigin[1] !== cors_api_host) {
        //             args[1] = cors_api_url + args[1];
        //         }
        //         return open.apply(this, args);
        //     };
        // })();
          
    const openWebcam = async () => {
      const webcamElement = document.getElementById('webcam');
      const stream = await navigator.mediaDevices.getUserMedia({
          video: {
              facingMode: 'environment'
          },
          audio: false
      })
	    webcamElement.srcObject = stream;
    }
          
    window.onload =async  function () {
      await openWebcam()
      document
        .querySelector(".say-hi-button")
        .addEventListener("click", function () {
          // here you can change also a-scene or a-entity properties, like
          // changing your 3D model source, size, position and so on
          // or you can just open links, trigger actions...
          // alert("Hi there!");
          capture();
        });
    };
    
    const b64toBlob = (b64Data, contentType = 'image/png', sliceSize = 512) => {
      const byteCharacters = atob(b64Data);
      const byteArrays = [];
    
      for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
    
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
    
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }
    
      const blob = new Blob(byteArrays, { type: contentType });
      return blob;
    }

    //  uploading file in storage
    async function uploadimage(base64){
      var storage = firebase.storage();
      const file = b64toBlob(base64.split(';base64,')[1]);
      var storageref=storage.ref();
      var thisref=storageref.child("image/png").child("test.png").put(file);
    }

    // Function to get get form values
    function getInputVal(id){
      return document.getElementById(id).value;
    }
        
    // Save message to firebase database
    function saveMessage(url){
      var newMessageRef = messagesRef.push();
      newMessageRef.set({
      imageurl:url,
      });
    }

    
    const capture = async () => {
      const webcamElement = document.getElementById('webcam');
      const canvas = document.getElementById("canvas");
      canvas.getContext('2d').drawImage(webcamElement, 0, 0, canvas.width, canvas.height);
   	  let image_data_url = canvas.toDataURL('image/jpeg');
      var messagesRef = await firebase.database().ref('Checking');
      await uploadimage(image_data_url);
      alert("Uploaded image")
      
      var url = `https://script.google.com/macros/s/AKfycbxebhtQBjtNfGMO_3Bium-SuIB4Bs6YLxamDwOIgfvC/exec?callback=resultServer&caller=Vasi`;
      // Make an AJAX call to Google Script
      try{
        const result = await jQuery.ajax({
          crossDomain: true,
          url: url,
          method: "GET",
          dataType: "jsonp"
        });
      } catch (err) {
        console.log("97: ", err);
      }
      
    };
    
    async function resultServer(e) {
        console.log("56", e);
        const result = e.result;
        console.log("114: ", result);
        alert("Text: "+ result)
        await callOrar();
        
    }
    
    const callOrar = async () => {
      // const result = await axios.get(`https://orar.usv.ro/orar/mobil/vizualizare/orarSPG.php?ID=25&mod=sala&mod2=vizual&print=da&back=&rand=0.15784193803221158`);
      const result = await axios.get(`https://cors-anywhere.herokuapp.com/https://orar.usv.ro/orar/mobil/vizualizare/orarSPG.php?ID=25&mod=sala&mod2=vizual&print=da&back=&rand=0.15784193803221158`);
      // const result = await axios.get(`https://cors-anywhere.herokuapp.com/https://dexonline.ro/definitie/casa/json`);
      alert("Result orar: " + JSON.stringify(result));
      let html = result.data;
      let found = false;
      
      if(html.includes('<table>')){
        html = html.split('<table>')[1];
        found = true;
        if(html.includes('</table>')){
          html = html.split('</table>')[0];
        } else {
          html = html.split('</TABLE>')[0];
        }
      } else if(html.includes('<TABLE>')){
        html = html.split('<TABLE>')[1];
        found = true;
        if(html.includes('</table>')){
          html = html.split('</table>')[0];
        } else {
          html = html.split('</TABLE>')[0];
        }
      }
      console.log("146: ", typeof html, html);
      console.log("126:", result.data.split('<table>')[1])
      const tabel = `<table></table>`;
      
      if(found) {
        const scene = document.getElementById("scene");
        const entity = document.createElement("a-entity");
        entity.style.position = "0 0 0";
        entity.htmlembed = true;
        entity.innerHTML = result.data
        console.log("151: ", entity)
        
        scene.appendChild(entity);
        console.log("153: ", scene);
      }   
    }


    
    
  </script>
  <style>
    .buttons {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 5em;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .say-hi-button {
      padding: 0.25em;
      border-radius: 4px;
      border: none;
      background: white;
      color: black;
      width: 4em;
      height: 2em;
    }
  </style>
  <body style="margin : 0px; overflow: hidden;">
  <canvas id="canvas" width="1280" height="720" style="display: none;"></canvas>
  <video id="webcam" width="1280" height="720" autoplay playsinline style="display: none;"></video>
    <!--<video id="webcam" autoplay playsinline style="display: none;"></video>-->
    <div class="buttons">
      <button class="say-hi-button">SAY HI!</button>
    </div>
    <a-scene embedded arjs vr-mode-ui="enabled: false;" id="scene">
      <a-marker preset="hiro">
        <a-entity
          position="0 0 0"
          scale="0.05 0.05 0.05"
          gltf-model="https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf"
        ></a-entity>
      </a-marker>
      <a-marker preset='kanji'>
        <a-box position='0 0.5 0' material='opacity: 0.5;'></a-box>
      </a-marker>
      <!--<a-marker preset="custom" type="pattern" url="https://drive.google.com/file/d/1Eo6vCIjvnDWduSyyQUzl0lf4EZljBCBk/view?usp=sharing">-->
        <!--<a-entity-->
        <!--   position="0 0 0"-->
        <!--  scale="0.05 0.05 0.05"-->
        <!--  > -->
        <!--</a-entity>-->
        <!--<a-box position='0 0.5 0' material='opacity: 0.5;'></a-box>-->
      <!--</a-marker>-->
      <!--<a-entity camera id='webcam'></a-entity>-->
    </a-scene>
  </body>
</html>